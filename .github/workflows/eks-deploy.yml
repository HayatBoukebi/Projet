name: CI-CD EKS

permissions:
  contents: read
  id-token: write

on:
  push:
    branches: ["main"]

env:
  AWS_REGION: eu-north-1
  ECR_REPO: demo-nginx
  EKS_CLUSTER_NAME: scrumptious-indie-ladybuggg

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configure AWS CLI
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3Ô∏è‚É£ Login to ECR
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.$AWS_REGION.amazonaws.com

      # 4Ô∏è‚É£ Build Docker image
      - name: Build Docker image
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          docker build -t $ECR_REPO:$IMAGE_TAG -f Dockerfile.dockerfile .
          docker tag $ECR_REPO:$IMAGE_TAG  ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Scan image with Trivy via Docker
      - name: Scan image with Trivy
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:0.42.1 image ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:${{ env.IMAGE_TAG }} || true

      # 6Ô∏è‚É£ Push image to ECR
      - name: Push to ECR
        run: |
          docker push  ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$IMAGE_TAG

      # 7Ô∏è‚É£ Update kubeconfig
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME

      # 8Ô∏è‚É£ Apply namespace before deploying
      - name: Apply namespace
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl wait --for=condition=Established --timeout=15s namespace/myapp

      # 9Ô∏è‚É£ Replace IMAGE_TAG and AWS_ACCOUNT_ID in deployment.yaml
      - name: Replace image tag
        run: |
          sed -i "s|IMAGE_TAG|$IMAGE_TAG|g" k8s/deployment.yaml
          sed -i "s|AWS_ACCOUNT_ID|${{ secrets.AWS_ACCOUNT_ID }}|g" k8s/deployment.yaml

      # üîü Deploy to EKS
      - name: Deploy to EKS
        run: |
          kubectl apply -f k8s/
          kubectl rollout status deployment/nginx-app -n myapp

      # 1Ô∏è‚É£1Ô∏è‚É£ Verify Gatekeeper
      - name: Verify Gatekeeper
        run: kubectl get constraints || true

      # 1Ô∏è‚É£2Ô∏è‚É£ Verify Kyverno
      - name: Verify Kyverno
        run: kubectl get events -A | grep kyverno || true
